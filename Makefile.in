# Target variables
MODE ?= Debug

# The Directories, Source, Includes, Objects, Binary 
ROOT   	        := .
3RD_PARTY_DIR   := $(ROOT)/sbg/3rd-party
GTEST_DIR       := googletest-release-1.10.0
GTEST_CODE      := $(GTEST_DIR).tar.gz
OBJ_DIR         := $(ROOT)/obj
BUILD_DIR    	:= $(OBJ_DIR)/release
ifeq ($(MODE),Debug)
BUILD_DIR    	:= $(OBJ_DIR)/debug
endif

# Flags, Libraries and Includes
INCLUDES := -I.
CXXFLAGS := -std=c++14 -Wall -Werror -Wno-reorder -O3 
ifeq ($(MODE),Debug)
CXXFLAGS 	+= -ggdb  
endif
LIB_SBGRAPH = lib/libsbgraph.a

all: $(LIB_SBGRAPH)

include sbg/Makefile.include

$(BUILD_DIR)/%.o : %.cpp
	$(CC) $(INCLUDES) $(CXXFLAGS) -MM -MT $@ -MF $(patsubst %.o,%.d,$@) $<
	$(CC) $(INCLUDES) -c $< -o $@ $(CXXFLAGS)

$(LIB_SBGRAPH): | create-folders $(SBG_OBJ) $(BUILDERS_OBJ) $(UTIL_OBJ)   
	$(AR) rcs $(LIB_SBGRAPH) $(SBG_OBJ) $(BUILDERS_OBJ) $(UTIL_OBJ)

lib-gtest: | create-folders 
ifeq ("$(wildcard $(3RD_PARTY_DIR)/gtest/usr/lib)","")
	cd $(3RD_PARTY_DIR)/gtest; tar xvzf $(GTEST_CODE)
	mkdir -p $(3RD_PARTY_DIR)/gtest/build
	cd $(3RD_PARTY_DIR)/gtest/build; cmake ../$(GTEST_DIR) -DCMAKE_INSTALL_PREFIX=../usr  
	cd $(3RD_PARTY_DIR)/gtest/build; make install 
	rm -rf $(3RD_PARTY_DIR)/gtest/$(GTEST_DIR)
	rm -rf $(3RD_PARTY_DIR)/gtest/build
endif

create-folders::
	@mkdir -p $(ROOT)/lib
	@mkdir -p $(OBJ_DIR)
	@mkdir -p $(BUILD_DIR)

test: lib-gtest $(SBG_GRAPH_TEST)

clean:
	$(RM) -rf $(OBJ_DIR) $(LIB_SBGRAPH) $(ROOT)/lib $(3RD_PARTY_DIR)/gtest/usr

help:
	@echo "make MODE=<Debug|Release> "
	@echo "Default values:"
	@echo ""
	@echo "MODE=Debug"
