/*
model testRLC1
  //iRa[i] and iRb[i] form an algebraic loop
    
  constant Integer N=10;
  Real iL[N],uC[N],uL[N],iRa[N],iRb[N],iC[N];
  parameter Real L=1,Ra=1,Rb=1,C=1,U=1;
equation
  for i in 1:N loop
    L*der(iL[i])=uL[i]; 
    C*der(uC[i])=iC[i];
    iRa[i]-iRb[i]-iL[i]=0; 
    uL[i]-Rb*iRb[i]-uC[i]=0; 
  end for;  
  for i in 2:N loop
    uC[i-1]-Ra*iRa[i]-Rb*iRb[i]-uC[i]=0; 
    iRb[i-1]-iRa[i]-iC[i-1]=0; 
  end for;  
  U-Ra*iRa[1]-uL[1]=0; 
  iRb[N]-iC[N]=0; // iC[N]
end testRLC1;
*/

N = 10

F1 = N
F2 = N+F1
F3 = N+F2
F4 = N+F3
F5 = N-1+F4
F6 = N-1+F5
F7 = 1+F6
F8 = 1+F7
U1 = N+F8 // iC
U2 = N+U1 // der(iL)
U3 = N+U2 // iRa
U4 = N+U3 // iRb
U5 = N+U4 // der(uC)
U6 = N+U5 // uL

E1 = N // F1 - der(iL[i])
E2 = N+E1 // F1 - uL[i]
E3 = N+E2 // F2 - iC[i]
E4 = N+E3 // F2 - der(uC[i])
E5 = N+E4 // F3 - iRa[i]
E6 = N+E5 // F3 - iRb[i]
E7 = N+E6 // F4 - iRb[i]
E8 = N+E7 // F4 - uL[i]
E9 = N-1+E8 // F5 - iRa[i]
E10 = N-1+E9 // F5 - iRb[i]
E11 = N-1+E10 // F6 - iC[i]
E12 = N-1+E11 // F6 - iRa[i]
E13 = N-1+E12 // F6 - iRb[1]
E14 = 1+E13 // F7 - iRa[1]
E15 = 1+E14 // F7 - uL[1]
E16 = 1+E15 // F8 - iC[N]
E17 = 1+E16 // F8 - iRb[N]

off1d = r(F1, 1)-r(E1, 1)
off2d = r(F1, 1)-r(E2, 1)
off3d = r(F2, 1)-r(E3, 1)
off4d = r(F2, 1)-r(E4, 1)
off5d = r(F3, 1)-r(E5, 1)
off6d = r(F3, 1)-r(E6, 1)
off7d = r(F4, 1)-r(E7, 1)
off8d = r(F4, 1)-r(E8, 1)
off9d = r(F5, 1)-r(E9, 1)
off10d = r(F5, 1)-r(E10, 1)
off11d = r(F6, 1)-r(E11, 1)
off12d = r(F6, 1)-r(E12, 1)
off13d = r(F6, 1)-r(E13, 1)
off14d = r(F7, 1)-r(E14, 1)
off15d = r(F7, 1)-r(E15, 1)
off16d = r(F8, 1)-r(E16, 1)
off17d = r(F8, 1)-r(E17, 1)

off1b = r(U2, 1)-r(E1, 1)
off2b = r(U6, 1)-r(E2, 1)
off3b = r(U1, 1)-r(E3, 1)
off4b = r(U5, 1)-r(E4, 1)
off5b = r(U3, 1)-r(E5, 1)
off6b = r(U4, 1)-r(E6, 1)
off7b = r(U4, 1)-r(E7, 1)
off8b = r(U6, 1)-r(E8, 1)
off9b = r(U3, 1)-r(E9, 1)
off10b = r(U4, 1)-E10
off11b = r(U1, 1)-E11-1
off12b = r(U3, 1)-E12
off13b = r(U4, 1)-E13-1
off14b = r(U3, 1)-E14-N+1
off15b = r(U6, 1)-E15-N+1
off16b = r(U1, 1)-E16
off17b = r(U4, 1)-E17

V %= {[1:1:F1], [F1+1:1:F2], [F2+1:1:F3], [F3+1:1:F4], [F4+1:1:F5], [F5+1:1:F6]
  , [F6+1:1:F7], [F7+1:1:F8], [F8+1:1:U1], [U1+1:1:U2], [U2+1:1:U3]
  , [U3+1:1:U4], [U4+1:1:U5], [U5+1:1:U6]};
Vmap %= <<{[1:1:F1]} -> 0*x+1, {[F1+1:1:F2]} -> 0*x+2, {[F2+1:1:F3]} -> 0*x+3
  , {[F3+1:1:F4]} -> 0*x+4, {[F4+1:1:F5]} -> 0*x+5, {[F5+1:1:F6]} -> 0*x+6
  , {[F6+1:1:F7]}-> 0*x+7, {[F7+1:1:F8]} -> 0*x+8, {[F8+1:1:U1]} -> 0*x+10
  , {[U1+1:1:U2]} -> 0*x+11, {[U2+1:1:U3]} -> 0*x+12, {[U3+1:1:U4]} -> 0*x+13
  , {[U4+1:1:U5]} -> 0*x+14, {[U5+1:1:U6]} -> 0*x+15>>;
map1 %= <<{[1:1:E1]} -> 1*x+off1d, {[E1+1:1:E2]} -> 1*x+off2d, {[E2+1:1:E3]} -> 1*x+off3d
  , {[E3+1:1:E4]} -> 1*x+off4d, {[E4+1:1:E5]} -> 1*x+off5d, {[E5+1:1:E6]} -> 1*x+off6d
  , {[E6+1:1:E7]} -> 1*x+off7d, {[E7+1:1:E8]} -> 1*x+off8d, {[E8+1:1:E9]} -> 1*x+off9d
  , {[E9+1:1:E10]} -> 1*x+off10d, {[E10+1:1:E11]} -> 1*x+off11d, {[E11+1:1:E12]} -> 1*x+off12d
  , {[E12+1:1:E13]} -> 1*x+off13d, {[E13+1:1:E14]} -> 1*x+off14d, {[E14+1:1:E15]} -> 1*x+off15d
  , {[E15+1:1:E16]} -> 1*x+off16d, {[E16+1:1:E17]} -> 1*x+off17d>>;
map2 %= <<{[1:1:E1]} -> 1*x+off1b, {[E1+1:1:E2]} -> 1*x+off2b, {[E2+1:1:E3]} -> 1*x+off3b
  , {[E3+1:1:E4]} -> 1*x+off4b, {[E4+1:1:E5]} -> 1*x+off5b, {[E5+1:1:E6]} -> 1*x+off6b
  , {[E6+1:1:E7]} -> 1*x+off7b, {[E7+1:1:E8]} -> 1*x+off8b, {[E8+1:1:E9]} -> 1*x+off9b
  , {[E9+1:1:E10]} -> 1*x+off10b, {[E10+1:1:E11]} -> 1*x+off11b, {[E11+1:1:E12]} -> 1*x+off12b
  , {[E12+1:1:E13]} -> 1*x+off13b, {[E13+1:1:E14]} -> 1*x+off14b, {[E14+1:1:E15]} -> 1*x+off15b
  , {[E15+1:1:E16]} -> 1*x+off16b, {[E16+1:1:E17]} -> 1*x+off17b>>;
Emap %= <<{[1:1:E1]} -> 0*x+1, {[E1+1:1:E2]} -> 0*x+2, {[E2+1:1:E3]} -> 0*x+15
  , {[E3+1:1:E4]} -> 0*x+3, {[E4+1:1:E5]} -> 0*x+4, {[E5+1:1:E6]} -> 0*x+5
  , {[E6+1:1:E7]} -> 0*x+6, {[E7+1:1:E8]} -> 0*x+7, {[E8+1:1:E9]} -> 0*x+8
  , {[E9+1:1:E10]} -> 0*x+9, {[E10+1:1:E11]} -> 0*x+10, {[E11+1:1:E12]} -> 0*x+11
  , {[E12+1:1:E13], [E13+1:1:E14]} -> 0*x+12, {[E14+1:1:E15]} -> 0*x+13
  , {[E15+1:1:E16]} -> 0*x+14, {[E16+1:1:E17]} -> 0*x+16>>;

matching(
V %= {[1:1:F1], [F1+1:1:F2], [F2+1:1:F3], [F3+1:1:F4], [F4+1:1:F5], [F5+1:1:F6]
  , [F6+1:1:F7], [F7+1:1:F8], [F8+1:1:U1], [U1+1:1:U2], [U2+1:1:U3]
  , [U3+1:1:U4], [U4+1:1:U5], [U5+1:1:U6]};
Vmap %= <<{[1:1:F1]} -> 0*x+1, {[F1+1:1:F2]} -> 0*x+2, {[F2+1:1:F3]} -> 0*x+3
  , {[F3+1:1:F4]} -> 0*x+4, {[F4+1:1:F5]} -> 0*x+5, {[F5+1:1:F6]} -> 0*x+6
  , {[F6+1:1:F7]}-> 0*x+7, {[F7+1:1:F8]} -> 0*x+8, {[F8+1:1:U1]} -> 0*x+10
  , {[U1+1:1:U2]} -> 0*x+11, {[U2+1:1:U3]} -> 0*x+12, {[U3+1:1:U4]} -> 0*x+13
  , {[U4+1:1:U5]} -> 0*x+14, {[U5+1:1:U6]} -> 0*x+15>>;
map1 %= <<{[1:1:E1]} -> 1*x+off1d, {[E1+1:1:E2]} -> 1*x+off2d, {[E2+1:1:E3]} -> 1*x+off3d
  , {[E3+1:1:E4]} -> 1*x+off4d, {[E4+1:1:E5]} -> 1*x+off5d, {[E5+1:1:E6]} -> 1*x+off6d
  , {[E6+1:1:E7]} -> 1*x+off7d, {[E7+1:1:E8]} -> 1*x+off8d, {[E8+1:1:E9]} -> 1*x+off9d
  , {[E9+1:1:E10]} -> 1*x+off10d, {[E10+1:1:E11]} -> 1*x+off11d, {[E11+1:1:E12]} -> 1*x+off12d
  , {[E12+1:1:E13]} -> 1*x+off13d, {[E13+1:1:E14]} -> 1*x+off14d, {[E14+1:1:E15]} -> 1*x+off15d
  , {[E15+1:1:E16]} -> 1*x+off16d, {[E16+1:1:E17]} -> 1*x+off17d>>;
map2 %= <<{[1:1:E1]} -> 1*x+off1b, {[E1+1:1:E2]} -> 1*x+off2b, {[E2+1:1:E3]} -> 1*x+off3b
  , {[E3+1:1:E4]} -> 1*x+off4b, {[E4+1:1:E5]} -> 1*x+off5b, {[E5+1:1:E6]} -> 1*x+off6b
  , {[E6+1:1:E7]} -> 1*x+off7b, {[E7+1:1:E8]} -> 1*x+off8b, {[E8+1:1:E9]} -> 1*x+off9b
  , {[E9+1:1:E10]} -> 1*x+off10b, {[E10+1:1:E11]} -> 1*x+off11b, {[E11+1:1:E12]} -> 1*x+off12b
  , {[E12+1:1:E13]} -> 1*x+off13b, {[E13+1:1:E14]} -> 1*x+off14b, {[E14+1:1:E15]} -> 1*x+off15b
  , {[E15+1:1:E16]} -> 1*x+off16b, {[E16+1:1:E17]} -> 1*x+off17b>>;
Emap %= <<{[1:1:E1]} -> 0*x+1, {[E1+1:1:E2]} -> 0*x+2, {[E2+1:1:E3]} -> 0*x+15
  , {[E3+1:1:E4]} -> 0*x+3, {[E4+1:1:E5]} -> 0*x+4, {[E5+1:1:E6]} -> 0*x+5
  , {[E6+1:1:E7]} -> 0*x+6, {[E7+1:1:E8]} -> 0*x+7, {[E8+1:1:E9]} -> 0*x+8
  , {[E9+1:1:E10]} -> 0*x+9, {[E10+1:1:E11]} -> 0*x+10, {[E11+1:1:E12]} -> 0*x+11
  , {[E12+1:1:E13], [E13+1:1:E14]} -> 0*x+12, {[E14+1:1:E15]} -> 0*x+13
  , {[E15+1:1:E16]} -> 0*x+14, {[E16+1:1:E17]} -> 0*x+16>>;
  , 1
)
